<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Coyote é—®ç­”æ¸¸æˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <script>
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
  </script>
  <style>
    body{font-family:Arial;padding:20px;background:#111;color:#0f0}
    button{padding:15px;font-size:18px;margin:10px 0;width:100%}
    #log{white-space:pre-wrap;font-size:14px;margin-top:20px}
  </style>
</head>
<body>
  <h1>ğŸ”— Coyote é—®ç­”æ¸¸æˆ</h1>
  <button onclick="connect()">è¿æ¥è®¾å¤‡</button>
  <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
  <div id="question"></div>
  <div id="choices"></div>
  <div id="log"></div>

  <script>
    let device, characteristic;
    let current = 0;
    const quiz = [
      {q:"Python æ˜¯ç¼–è¯‘å‹è¯­è¨€å—ï¼Ÿ",a:["æ˜¯","å¦"],c:1},
      {q:"WebBluetooth æ”¯æŒ iPhone å—ï¼Ÿ",a:["æ”¯æŒ","ä¸æ”¯æŒ"],c:1},
      {q:"Coyote æœ‰å‡ ä¸ªé€šé“ï¼Ÿ",a:["1","2"],c:1}
    ];

    function log(m){document.getElementById('log').textContent+=m+'\n'}

    async function connect(){
      try{
        device=await navigator.bluetooth.requestDevice({
          filters:[{namePrefix:'Coyote'}],
          optionalServices:['0000ffe0-0000-1000-8000-00805f9b34fb']
        });
        const server=await device.gatt.connect();
        const service=await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
        characteristic=await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
        log("âœ… å·²è¿æ¥ Coyote");
      }catch(e){log("âŒ è¿æ¥å¤±è´¥: "+e)}
    }

    async function sendCommand(a,b,wave,freq,on){
      if(!characteristic)return;
      const cmd=new Uint8Array([a,b,wave,freq,0,on?0x01:0x00]);
      await characteristic.writeValue(cmd);
    }

    function showQuestion(){
      const q=quiz[current];
      document.getElementById('question').innerHTML='<h2>'+q.q+'</h2>';
      document.getElementById('choices').innerHTML=q.a.map((ans,i)=>
        `<button onclick="check(${i})">${ans}</button>`).join('');
    }

    async function check(i){
      const correct=quiz[current].c;
      if(i===correct){
        log("âœ… ç­”å¯¹ï¼"); await sendCommand(0,0,0,0,false);
      }else{
        log("âŒ ç­”é”™ï¼ç”µå‡»ï¼"); await sendCommand(20,10,Math.floor(Math.random()*5),1,true);
        setTimeout(()=>sendCommand(0,0,0,0,false),3000);
      }
      current++; if(current<quiz.length){setTimeout(showQuestion,1000)}else{log("ğŸ‰ æ¸¸æˆç»“æŸï¼")}
    }

    function startGame(){if(!characteristic){log("è¯·å…ˆè¿æ¥è®¾å¤‡");return;} current=0; showQuestion();}
  </script>
</body>
</html>
